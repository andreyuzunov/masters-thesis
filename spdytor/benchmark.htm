<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Benchmark page: page load time in iframe with JavaScript</title>
<script type="text/javascript">
<!--
var begin_time;
var page_start_time;
var urls = new Array();
var times = new Array();// 2D
var current_url = -1;
var current_iteration = -1;
var pause_between = 0;
var iterations = 1;
var stopped = false;
var timeout = 10;
var timeout_fired = false;
var timeoutID;

function run_benchmark()
{
  begin_time = (new Date()).getTime();
  urls = new Array();
  times = new Array();
  var fr = document.getElementById('iframe_container');
  var lines = document.getElementById('urls').value.split(/\r\n|\r|\n/);
  iterations = document.getElementById('iterations').value;
  timeout = document.getElementById('timeout').value;
  
  for(var i=0,j=0; i<lines.length; i++)
  {
    if(lines[i] && lines[i].length > 0) urls[j++]=lines[i];
  }
  pause_between = document.getElementById('pause_between').value;
  current_url = -1;
  current_iteration = -1;
  display_data();
  current_url = 0;
  current_iteration = 0;
  
  stopped = false;
  //fr.onload=page_loaded;
  load_current();
}

function page_loaded(process_it)
{
  if(process_it!=true && timeout_fired) 
  {
    //console.log('page_loaded unneeded');
    return;
  }
  clearTimeout(timeoutID);
  //console.log('page_loaded '+process_it+' ' +timeout_fired);
  var load_time = (new Date()).getTime() - page_start_time;
  var fr = document.getElementById('iframe_container');
  fr.onload=null;
  fr.src='about:blank';
  if(!timeout_fired)
  {
    if(!times[current_url])
      times[current_url] = new Array();
    times[current_url][current_iteration] = load_time;
  }
  
  display_data();

  current_url++;
  if(current_url == urls.length)
  {
    current_url=0;
    current_iteration++;
  }
  if(current_iteration < iterations)
  {
    setTimeout(load_current, pause_between * 1000);
  }
  else stop_benchmark();
}

function stop_slow_results()
{
  //console.log('stop_slow_results');
  timeout_fired = true;
  if(!times[current_url])
    times[current_url] = new Array();
  //else if(times[current_url][current_iteration])
  //  console.log('stop_slow_results race conditions!');
  times[current_url][current_iteration] = 'TIMEOUT';
  
  page_loaded(true);
}

function load_current()
{
  if(stopped) return;
  timeout_fired = false;
  //console.log('cur iter '+current_iteration);
  //console.log('loading '+urls[current_url]);
  //console.log('total '+iterations);
  var fr = document.getElementById('iframe_container');
  fr.onload=page_loaded;
  page_start_time = (new Date()).getTime();
  timeoutID=setTimeout(stop_slow_results, timeout * 1000);
  fr.src = urls[current_url];
}

function display_data()
{
  //console.log('display_data');
  var res = document.getElementById('results');
  var res_table = document.getElementById('results_table');
  var stat_table = document.getElementById('statistics_table');
  
  var done = (current_url+1 + urls.length*Math.max(current_iteration,0));
  var time_passed = (new Date()).getTime() - begin_time;
  var time_left = time_passed / done * (urls.length * iterations - done);
  
  var text_status = '<pre><div>Done: '+done+' / '+(urls.length * iterations)+' urls</div><div>Time passed: '+(time_passed/1000)+' s</div><div>Time left (est): '+(time_left/1000)+' s</div></pre>';
  var text_results = "COUNT; URL; LOAD_TIME(ms)\n";
  var text_statistics = "COUNT; URL; ITERATIONS; MEDIAN; AVG; MIN; MAX\n";
  var sum = new Array(); //2D
  var statistics = new Array(); //2D
  var cnt = 1;
  for(var i=0; i< iterations; i++)
  {
    for(var u=0; u< urls.length; u++, cnt++)
    {
      var curtime;
      if(!statistics[u])
      {
        sum[u] = 0;
        statistics[u] = new Array();
      }
      
      if(i<current_iteration || i==current_iteration && u<=current_url)
      {
        if('TIMEOUT' != times[u][i])
        {
          curtime = times[u][i];
          statistics[u][statistics[u].length] = curtime;
          sum[u] += curtime;
        }
        else
        {
          curtime = 'TIMEOUT';
        }
      }
      else
      {
        curtime = 'N/A';
      }
      text_results += (cnt)+'; '+urls[u]+'; '+curtime+'\n';
    }
  }
  
  for(var u=0; u< urls.length; u++)
  {
    statistics[u].sort(function(a,b){return a-b});
    var median = statistics[u].length%2
      ? statistics[u][(statistics[u].length - 1)/2]
      : (statistics[u][statistics[u].length/2 - 1]+statistics[u][statistics[u].length/2])/2;
    text_statistics += (u+1)+'; '
      +urls[u]+'; '
      +statistics[u].length +'; '
      +median+'; '
      +(sum[u] / statistics[u].length)+'; '
      +statistics[u][0]+'; '
      +statistics[u][statistics[u].length - 1]+'\n';
  }
  
  res.innerHTML = text_status;
  res_table.value = text_results;
  stat_table.value = text_statistics;
}

function stop_benchmark()
{
  stopped = true;
  //console.log('stop_benchmark');
  clearTimeout(timeoutID);
  var fr = document.getElementById('iframe_container');
  fr.onload=null;
  fr.src='about:blank';
}
//-->
</script>
</head>

<body>
<h1>Benchmark page: page load time in iframe with JavaScript</h1>
checkip.dyndns.org:
<iframe id="iframe_ip" width="400" height="40" src="http://checkip.dyndns.org"></iframe>

<form action="" method="post" name="feedback">
<div>Seconds between page loads: <input type="text" value="3" name="pause_between" id="pause_between" /></div>
<div>Timeout for a page load (seconds): <input type="text" value="60" name="timeout" id="timeout" /></div>
<p>Addresses that will be loaded in this order:</p>
<textarea name="urls" id="urls" cols="100" rows="6">
http://www.ebay.de/
http://www.spiegel.de/
</textarea>
<div>Number of iterations: <input type="text" value="1" name="iterations" id="iterations" /></div>
<p><a href="javascript:run_benchmark();">Run it</a> (results so far will be deleted!) <a href="javascript:stop_benchmark();">Stop it</a></p>
</form>

<p>page will load here:</p>
<iframe id="iframe_container" width="640" height="120" src="about:blank"></iframe>
<div id="results">Status here...</div>
<div>Statistics:</div>
<textarea name="statistics_table" id="statistics_table" cols="100" rows="6">
</textarea>
<div>All results:</div>
<textarea name="results_table" id="results_table" cols="100" rows="6">
</textarea>
<hr />
<i>ver. 1.3, 2013-07-18, Copyright (C) Andrey Uzunov</i>

</body>
</html>
